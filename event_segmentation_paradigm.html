<!DOCTYPE html>
<html>

<head>
  <script src="./jspsych/dist/jspsych.js"></script>
  <script src="./plugin-html-button-response.js"></script>
  <script src="./jspsych/dist/plugin-html-keyboard-response.js"></script>
  <script src="./jspsych/dist/plugin-video-keyboard-response.js"></script>
  <script src="./plugin-event-segmentation.js"></script>
  <script src="./jspsych/dist/plugin-preload.js"></script>
  <script src="./jspsych/dist/plugin-fullscreen.js"></script>
  <script src="./plugin-likert-survey.js"></script>
  <script src="./plugin-text-survey.js"></script>
  <script src="./input.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="./jspsych/dist/jspsych.css">
</head>

<body>
</body>

<script>
var jsPsych = initJsPsych({
   override_safe_mode:true,
    on_finish: function(data){
    window.location.assign("https://ucdavis.sona-systems.com/webstudy_credit.aspx?experiment_id=2814&credit_token=ec0ffa50d82946bbb1b0f84d7f8db001&survey_code="+sona_id);
    document.body.style.cursor = 'default';
  }
  });

  /* create timeline */
  var timeline = [];
  let sona_id = jsPsych.data.urlVariables()['sona_id']
  var participant_id;
  if (sona_id){
    participant_id = sona_id
  } else{
    participant_id = 0000
  }

  var test_stimuli = stimuli.slice(0,2);
  stimuli = stimuli.slice(2,stimuli.length);

  var test_videos = [
    test_stimuli.map(a => a.video_one),
  ]

  var videos = [
    stimuli.map(a => a.video_one),
  ]

  /* preload images */
  var preload_demo = {
    type: jsPsychPreload,
    video: test_videos,
    data:{participant_id:participant_id},
  };
  timeline.push(preload_demo);


  var fullscreen_start = {
    type: jsPsychFullscreen,
    fullscreen_mode: true,
    data:{participant_id:participant_id},
  };
  timeline.push(fullscreen_start);


  var start = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h3>Welcome to the experiment!</h3><p>Your goal in this experiment is to <b>segment videos into meaningful units.</b></p>',
    choices: ['Next'],
    data:{participant_id:participant_id},
  };

  timeline.push(start);

  var introduction = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p> This experiment should take about 20-25 minutes of your time. You will receive 0.5 credits upon completion."+
               "<br> "+
               "<br> You will be watching some clips from the movie 1917 <strong>without any audio </strong>." +
               "<br> "+
               "<br> 1917 was released in 2019 - This movie is famous for its single long shot cinematography with no scene cuts." +
               "<br> "+
               "<br>This means that visually the movie watching experience should be smooth and continuous without any disruptions.</p>",
    choices: ["Next"],
    data:{participant_id:participant_id},
  };
  timeline.push(introduction);

  var introduction2 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>Your job is to segment the video into <strong>small meaningful units </strong>" +
               "<br> "+
               "<br> A meaningful unit is usually something that stands out by itself - and doesn't require the rest of the video to understand"+
               "<br> "+
               "<br> Tap <strong>SPACE BAR</strong> when in your judgment, one unit ends, and the other begins.</p>",
    choices: ["Next"],
    data:{participant_id:participant_id},
  };
  timeline.push(introduction2);


  var introduction4 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p> Remember there is <strong> no correct </strong> answer!"+
    "<br>" +
    "<br> You should just mark these videos into smallest units that seem natural and meaningful to you."+
    "<br>" +
    "<br> Let's do a demo trial to get you acquainted with the paradigm.</p>",
    choices: ["Okay, let's get started!"],
    data:{participant_id:participant_id},
  };
  timeline.push(introduction4);


  var demo_trial1 = {
    type: jsPsychEventSegmentation,
    response_allowed_while_playing:true,
    width:1000,
    stimulus:[test_stimuli[0].video_one],
    choices: ' ',
    trial_ends_after_video:true,
    prompt: true,
    mute:true,
    response_ends_trial:false,
    participant_id: participant_id,
  };

  timeline.push({
    timeline: [demo_trial1],
    timeline_variables: test_stimuli[0]
              });

  var demo_explanation = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p align=left> Notice how many different events were there."+
    "<br>" +
    "<br> In here, the actor was <ul> <li> brushing their teeth - this act involved brushing, spitting into the sink, washing their mouth, air drying the brush and putting it back in its place, wiping their mouth <li> cleansing using mouth wash - this involved picking up the mouthwash from the counter, gargling, closing the bottle and putting it back, setting a timer  </ul>."+
    "<br>" +
    "Let us try and segment the story into meaningful units keeping this detail in mind <br></p>",,
    choices: ["Let us watch a video showing how to segment the video"],
    data:{participant_id:participant_id},
  };

  timeline.push(demo_explanation);

var demo_trial2 = {
    type: jsPsychVideoNoAudioButtonResponse,
    stimulus: [test_stimuli[0].video_one],
    choices: ['Continue'],
    margin_vertical: '10px',
    margin_horizontal: '8px',
    autoplay: true,
    controls: true,
    rate:2,
    response_ends_trial: true,
    response_allowed_while_playing: false,
    mute:true,
  };

  timeline.push({
    timeline: [demo_trial2],
    timeline_variables: test_stimuli[0]
              });

  var demo_explanation2 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p> Hopefully this demo helped you understand what we mean by small meaningful units"+
    "<br> "+
    "<br> Remember, there is no correct answer for what a meaninful unit is!"+
    "<br> "+
    "<br> We just want to know if there are certain segments of the video that you think are natural and meaningful ."+
    "<br> "+
    "<br> Get ready now! Let's segment some more video clips. </p>",
    choices: ["Let's get started"],
    data:{participant_id:participant_id},
  };

  timeline.push(demo_explanation2);

  /* preload images */
  var preload = {
    type: jsPsychPreload,
    video: videos,
    message: "Preloading the videos. This might take a while. Please bear with me :)",
    data:{participant_id:participant_id},
  };
  timeline.push(preload);



  var trial = {
    type: jsPsychEventSegmentation,
    response_allowed_while_playing:true,
    width:1000,
    stimulus:[jsPsych.timelineVariable('video_one')],
    choices: ' ',
    trial_ends_after_video:true,
    prompt: true,
    mute:true,
    response_ends_trial:false,
    participant_id: participant_id,
  };


  timeline.push({
    timeline: [trial],
    timeline_variables: stimuli
              });


  var end_note = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>THE END.<br>" +
    "Thank you for participating. The experiment is done. <strong> Do not close yet. </strong>"+
    "<br>"+
    "<br> Please answer a few questions before exiting. Following this, you will be <strong> redirected to the SONA page </strong> to get your credits."+
    "<br>"+
    "<br> If you have any questions, please reach out to saupadhy@ucdavis.edu.</p>",
    choices: ["Got it"],
    data:{participant_id:participant_id},
  }
  timeline.push(end_note);

  var scale = ["Strongly Disagree", "Disagree", "Neutral", "Agree", "Strongly Agree"];

  var likert_trial = {
      type: jsPsychLikertSurvey,
      questions: [
        {prompt: "There were no issues with the video loading", name: 'Video loading', labels: scale, required: true},
        {prompt: "The instructions were clear to understand the experiment", name: 'Instructions', labels: scale, required: true},
      ],
      data:{participant_id:participant_id},
  };

  timeline.push(likert_trial);

  var survey_page = {
    type: jsPsychTextSurvey,
    questions: [
      {prompt: 'Other comments', placeholder: 'Type N/A if none', rows:10, columns: 50}
    ],
    data:{participant_id:participant_id},
  };

  timeline.push(survey_page);

  var fullscreen_trial_exit = {
    type: jsPsychFullscreen,
    fullscreen_mode: false,
    data:{participant_id:participant_id},
  };

  timeline.push(fullscreen_trial_exit);

  if (typeof jsPsych !== "undefined") {
    jsPsych.run(timeline);
  } else {
    document.body.innerHTML = '<div style="text-align:center; margin-top:50%; transform:translate(0,-50%);">You must be online to view the demo.</div>';
  }
</script>

</html>
